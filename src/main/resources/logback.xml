<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- AP編號 -->
    <property name="AP_NUMBER" value="95"/>

    <!-- 日誌保留天數 -->
    <property name="LOG_MAX_HISTORY" value="180"/>

    <!-- 定義日誌輸出格式 -->
    <property name="LOG_PATTERN" value="%d{yyyy/MM/dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"/>

    <property name="LOG_PATH" value="/opt/AP/Patch_log/${AP_NUMBER}/"/>

    <property name="NODE_ENV" value="${NODE_ENV:-local}"/>

    <!-- 根據 NODE_ENV 使用巢狀結構設定 SMTP host，讓邏輯更集中 -->
    <if condition='property("NODE_ENV").equals("prod")'>
        <then>
            <property name="SMTP_HOST" value="oms-s.104.com.tw"/>
            <property name="ENV_NAME" value="PROD"/>
        </then>
        <else>
            <if condition='property("NODE_ENV").equals("staging")'>
                <then>
                    <property name="SMTP_HOST" value="oms-s.104-staging.com.tw"/>
                    <property name="ENV_NAME" value="STAGING"/>
                </then>
                <else>
                    <!-- local, lab 或未設定時的預設值 -->
                    <property name="SMTP_HOST" value="oms-s.104-dev.com.tw"/>
                    <property name="ENV_NAME" value="DEV"/>
                </else>
            </if>
        </else>
    </if>

    <!-- Console Appender -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- File Appender - 每天產生一個新的日誌檔案 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!--        <file>${LOG_PATH}/AP${AP_NUMBER}.log</file>-->
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/AP${AP_NUMBER}_%d{yyyyMMdd}.log</fileNamePattern>
            <maxHistory>${LOG_MAX_HISTORY}</maxHistory>
        </rollingPolicy>
    </appender>
    <appender name="ASYNC" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE" />
    </appender>

    <!-- SMTP Appender for ERROR level -->
    <appender name="EMAIL" class="ch.qos.logback.classic.net.SMTPAppender">
        <smtpHost>${SMTP_HOST}</smtpHost>
        <smtpPort>25</smtpPort>
        <to>wayne.li@104.com.tw</to>
        <to>jason.ko@104.com.tw</to>
        <to>peter.tsai@104.com.tw</to>
        <from>ap-alert@104.com.tw</from>
        <subject>【AP${AP_NUMBER} ERROR】[${ENV_NAME}] %logger{20} - %m</subject>
        <layout class="ch.qos.logback.classic.html.HTMLLayout">
            <pattern>%date%level%thread%logger{35}%line%message</pattern>
        </layout>
        <!-- 同步發送可以立即顯示 SMTP 錯誤，避免錯誤被靜默忽略 -->
        <asynchronousSending>false</asynchronousSending>
        <!-- 觸發條件: ERROR 級別 -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>
        <!-- Evaluator: 每次 ERROR 就觸發郵件 -->
        <evaluator class="ch.qos.logback.classic.boolex.OnErrorEvaluator" />
        <!-- 緩衝區大小 (在錯誤發生時一次性發送最近的多條日誌) -->
        <cyclicBufferTracker class="ch.qos.logback.core.spi.CyclicBufferTracker">
            <bufferSize>10</bufferSize>
        </cyclicBufferTracker>
    </appender>

    <!-- Root Logger -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC"/>
        <appender-ref ref="EMAIL"/>
    </root>
</configuration>